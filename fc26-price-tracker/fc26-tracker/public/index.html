<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>FC26 Price Tracker</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
<style>
:root {
  --bg-primary: #0a0e17;
  --bg-secondary: #111827;
  --bg-card: #161f33;
  --bg-card-hover: #1c2742;
  --bg-input: #0d1321;
  --border: #1e2d4a;
  --border-focus: #3b82f6;
  --text-primary: #e8ecf4;
  --text-secondary: #8594b0;
  --text-muted: #4f6085;
  --accent-blue: #3b82f6;
  --accent-blue-dim: #1e40af;
  --accent-green: #10b981;
  --accent-green-bg: rgba(16, 185, 129, 0.08);
  --accent-green-border: rgba(16, 185, 129, 0.25);
  --accent-red: #ef4444;
  --accent-red-bg: rgba(239, 68, 68, 0.08);
  --accent-red-border: rgba(239, 68, 68, 0.25);
  --accent-amber: #f59e0b;
  --accent-amber-bg: rgba(245, 158, 11, 0.08);
  --accent-amber-border: rgba(245, 158, 11, 0.25);
  --radius: 10px;
  --radius-sm: 6px;
  --shadow: 0 4px 24px rgba(0, 0, 0, 0.35);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Outfit', sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  line-height: 1.5;
}

.mono { font-family: 'JetBrains Mono', monospace; }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg-primary); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

/* Layout */
.app-shell { display: flex; flex-direction: column; min-height: 100vh; }

.topbar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 24px; height: 60px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
  position: sticky; top: 0; z-index: 100;
}

.topbar-logo {
  display: flex; align-items: center; gap: 10px;
  font-weight: 700; font-size: 18px; letter-spacing: -0.5px;
}

.topbar-logo .icon {
  width: 32px; height: 32px; border-radius: 8px;
  background: linear-gradient(135deg, #3b82f6, #8b5cf6);
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; font-weight: 800; color: #fff;
}

.topbar-actions { display: flex; align-items: center; gap: 10px; }

.main-content { flex: 1; padding: 24px; max-width: 1400px; margin: 0 auto; width: 100%; }

/* Buttons */
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 8px 16px; border-radius: var(--radius-sm);
  font-family: 'Outfit', sans-serif; font-weight: 500; font-size: 13px;
  border: 1px solid var(--border); background: var(--bg-card);
  color: var(--text-primary); cursor: pointer;
  transition: all 0.15s ease;
}
.btn:hover { background: var(--bg-card-hover); border-color: var(--text-muted); }
.btn:active { transform: scale(0.97); }

.btn-primary {
  background: var(--accent-blue); border-color: var(--accent-blue);
  color: #fff;
}
.btn-primary:hover { background: #2563eb; border-color: #2563eb; }

.btn-danger { color: var(--accent-red); }
.btn-danger:hover { background: var(--accent-red-bg); border-color: var(--accent-red-border); }

.btn-sm { padding: 5px 10px; font-size: 12px; }

.btn-icon {
  width: 34px; height: 34px; padding: 0;
  display: flex; align-items: center; justify-content: center;
}

/* Cards */
.card {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 20px;
}

/* Stats row */
.stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 24px; }

.stat-card {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 16px 18px;
}
.stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 4px; }
.stat-value { font-family: 'JetBrains Mono', monospace; font-size: 22px; font-weight: 700; }

/* Table */
.table-wrap { overflow-x: auto; }

table { width: 100%; border-collapse: collapse; }
thead th {
  text-align: left; padding: 10px 14px;
  font-size: 11px; text-transform: uppercase; letter-spacing: 1px;
  color: var(--text-muted); border-bottom: 1px solid var(--border);
  font-weight: 500; white-space: nowrap;
}
tbody td {
  padding: 12px 14px; border-bottom: 1px solid var(--border);
  font-size: 14px; vertical-align: middle;
}
tbody tr { transition: background 0.1s; }
tbody tr:hover { background: var(--bg-card-hover); }
tbody tr:last-child td { border-bottom: none; }

/* Badges */
.badge {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 3px 8px; border-radius: 4px;
  font-size: 11px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.5px;
}
.badge-buy { background: var(--accent-green-bg); color: var(--accent-green); border: 1px solid var(--accent-green-border); }
.badge-sell { background: var(--accent-red-bg); color: var(--accent-red); border: 1px solid var(--accent-red-border); }
.badge-high { background: var(--accent-green-bg); color: var(--accent-green); border: 1px solid var(--accent-green-border); }
.badge-medium { background: var(--accent-amber-bg); color: var(--accent-amber); border: 1px solid var(--accent-amber-border); }
.badge-low { background: var(--accent-red-bg); color: var(--accent-red); border: 1px solid var(--accent-red-border); }

/* Price display */
.price { font-family: 'JetBrains Mono', monospace; font-weight: 600; }
.price-up { color: var(--accent-green); }
.price-down { color: var(--accent-red); }
.price-neutral { color: var(--text-secondary); }

/* Trend arrow */
.trend { display: inline-flex; align-items: center; gap: 3px; font-size: 12px; font-weight: 600; }
.trend-up { color: var(--accent-green); }
.trend-down { color: var(--accent-red); }

/* Modal */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7);
  display: flex; align-items: center; justify-content: center;
  z-index: 1000; backdrop-filter: blur(4px);
  animation: fadeIn 0.15s ease;
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

.modal {
  background: var(--bg-secondary); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 28px;
  width: 90%; max-width: 480px;
  box-shadow: var(--shadow);
  animation: slideUp 0.2s ease;
}

.modal h2 { font-size: 18px; font-weight: 700; margin-bottom: 20px; }

.form-group { margin-bottom: 16px; }
.form-label { display: block; font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; }

.form-input, .form-select {
  width: 100%; padding: 10px 12px;
  background: var(--bg-input); border: 1px solid var(--border);
  border-radius: var(--radius-sm); color: var(--text-primary);
  font-family: 'Outfit', sans-serif; font-size: 14px;
  transition: border-color 0.15s;
}
.form-input:focus, .form-select:focus {
  outline: none; border-color: var(--accent-blue);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
}
.form-input::placeholder { color: var(--text-muted); }

.form-select { cursor: pointer; }
.form-select option { background: var(--bg-secondary); }

.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

.form-hint { font-size: 11px; color: var(--text-muted); margin-top: 4px; }

.modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px; }

/* Section headers */
.section-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 16px;
}
.section-title { font-size: 16px; font-weight: 700; letter-spacing: -0.3px; }
.section-subtitle { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

/* Tabs */
.tabs { display: flex; gap: 2px; margin-bottom: 24px; background: var(--bg-secondary); border-radius: var(--radius-sm); padding: 3px; border: 1px solid var(--border); width: fit-content; }
.tab {
  padding: 8px 18px; border-radius: var(--radius-sm);
  font-size: 13px; font-weight: 500; cursor: pointer;
  color: var(--text-secondary); background: transparent;
  border: none; transition: all 0.15s;
}
.tab:hover { color: var(--text-primary); }
.tab.active { background: var(--bg-card); color: var(--text-primary); box-shadow: 0 1px 4px rgba(0,0,0,0.2); }

/* Player card row */
.player-row-name { display: flex; align-items: center; gap: 10px; }
.player-avatar {
  width: 36px; height: 36px; border-radius: 8px;
  background: linear-gradient(135deg, var(--accent-blue-dim), var(--accent-blue));
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 13px; color: #fff; flex-shrink: 0;
}
.player-name-text { font-weight: 600; font-size: 14px; }
.player-meta { font-size: 11px; color: var(--text-muted); }

/* Chart container */
.chart-container { position: relative; height: 300px; margin: 16px 0; }

/* Opportunity cards */
.opp-card {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 16px 18px;
  margin-bottom: 10px; transition: border-color 0.15s;
}
.opp-card.buy { border-left: 3px solid var(--accent-green); }
.opp-card.sell { border-left: 3px solid var(--accent-red); }
.opp-card:hover { border-color: var(--text-muted); }

.opp-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
.opp-player { font-weight: 600; font-size: 15px; }
.opp-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; }
.opp-detail-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-muted); }
.opp-detail-value { font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 600; margin-top: 2px; }

/* Empty state */
.empty-state {
  text-align: center; padding: 60px 20px;
  color: var(--text-muted);
}
.empty-state-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.3; }
.empty-state-title { font-size: 16px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }
.empty-state-text { font-size: 13px; max-width: 360px; margin: 0 auto; }

/* Loading spinner */
.spinner {
  display: inline-block; width: 16px; height: 16px;
  border: 2px solid var(--border); border-top-color: var(--accent-blue);
  border-radius: 50%; animation: spin 0.6s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Toast */
.toast-container { position: fixed; top: 72px; right: 24px; z-index: 2000; display: flex; flex-direction: column; gap: 8px; }
.toast {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 12px 16px;
  font-size: 13px; box-shadow: var(--shadow);
  animation: slideIn 0.2s ease; min-width: 260px;
  display: flex; align-items: center; gap: 8px;
}
.toast.success { border-left: 3px solid var(--accent-green); }
.toast.error { border-left: 3px solid var(--accent-red); }
.toast.info { border-left: 3px solid var(--accent-blue); }
@keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

/* Responsive */
@media (max-width: 768px) {
  .main-content { padding: 16px; }
  .stats-row { grid-template-columns: repeat(2, 1fr); }
  .form-row { grid-template-columns: 1fr; }
  .topbar { padding: 0 16px; }
  .topbar-logo span:last-child { display: none; }
  .tabs { width: 100%; }
  .tab { flex: 1; text-align: center; padding: 8px 10px; font-size: 12px; }
}

/* Pulse animation for live indicator */
.live-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--accent-green); display: inline-block;
  animation: pulse 2s ease-in-out infinite;
}
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

/* Settings */
.settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
@media (max-width: 600px) { .settings-grid { grid-template-columns: 1fr; } }

.toggle-wrap { display: flex; align-items: center; gap: 10px; }
.toggle {
  width: 40px; height: 22px; border-radius: 11px;
  background: var(--border); position: relative; cursor: pointer;
  transition: background 0.2s;
}
.toggle.on { background: var(--accent-blue); }
.toggle-knob {
  width: 16px; height: 16px; border-radius: 50%;
  background: #fff; position: absolute; top: 3px; left: 3px;
  transition: transform 0.2s;
}
.toggle.on .toggle-knob { transform: translateX(18px); }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useCallback, useMemo } = React;

// â”€â”€â”€ Storage helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STORAGE_KEYS = {
  PLAYERS: "fc26_players",
  PRICES: "fc26_prices",
  SETTINGS: "fc26_settings",
};

function loadJSON(key, fallback) {
  try { return JSON.parse(localStorage.getItem(key)) || fallback; }
  catch { return fallback; }
}
function saveJSON(key, data) { localStorage.setItem(key, JSON.stringify(data)); }

// â”€â”€â”€ Price analysis helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function analyzePlayer(playerId, prices) {
  const history = (prices[playerId] || []).slice(-288); // last 24h at 5min intervals
  if (history.length < 3) return null;

  const values = history.map(p => p.price);
  const avg = values.reduce((a, b) => a + b, 0) / values.length;
  const current = values[values.length - 1];
  const min = Math.min(...values);
  const max = Math.max(...values);
  const volatility = avg > 0 ? ((max - min) / avg) * 100 : 0;
  const percentChange = avg > 0 ? ((current - avg) / avg) * 100 : 0;

  // Trend: compare last 3 to previous 3
  const recent = values.slice(-3);
  const prior = values.slice(-6, -3);
  const recentAvg = recent.reduce((a, b) => a + b, 0) / recent.length;
  const priorAvg = prior.length ? prior.reduce((a, b) => a + b, 0) / prior.length : recentAvg;
  const trendDir = recentAvg > priorAvg ? "up" : recentAvg < priorAvg ? "down" : "flat";

  return { avg: Math.round(avg), current, min, max, volatility: volatility.toFixed(1), percentChange: percentChange.toFixed(1), trend: trendDir };
}

function detectOpportunities(players, prices, threshold = 0.08) {
  const opps = [];
  for (const player of players) {
    const stats = analyzePlayer(player.id, prices);
    if (!stats || !stats.current) continue;

    const discount = (stats.avg - stats.current) / stats.avg;
    const premium = (stats.current - stats.avg) / stats.avg;

    let confidence = "LOW";
    if (stats.volatility < 5) confidence = "HIGH";
    else if (stats.volatility < 15) confidence = "MEDIUM";

    if (discount >= threshold) {
      const sellPrice = Math.round(stats.avg * 0.97);
      const profit = Math.round(sellPrice * 0.95 - stats.current);
      const roi = stats.current > 0 ? ((profit / stats.current) * 100).toFixed(1) : 0;
      opps.push({
        type: "BUY", player, stats, discount: (discount * 100).toFixed(1),
        sellPrice, profit, roi, confidence,
        timestamp: new Date().toISOString(),
      });
    } else if (premium >= threshold) {
      opps.push({
        type: "SELL", player, stats, premium: (premium * 100).toFixed(1),
        confidence, timestamp: new Date().toISOString(),
      });
    }
  }
  return opps.sort((a, b) => parseFloat(b.discount || b.premium || 0) - parseFloat(a.discount || a.premium || 0));
}

function formatCoins(n) {
  if (n == null) return "â€”";
  if (n >= 1000000) return (n / 1000000).toFixed(1) + "M";
  if (n >= 1000) return (n / 1000).toFixed(1) + "K";
  return n.toLocaleString();
}

function timeAgo(iso) {
  if (!iso) return "";
  const diff = (Date.now() - new Date(iso).getTime()) / 1000;
  if (diff < 60) return "just now";
  if (diff < 3600) return Math.floor(diff / 60) + "m ago";
  if (diff < 86400) return Math.floor(diff / 3600) + "h ago";
  return Math.floor(diff / 86400) + "d ago";
}

// â”€â”€â”€ Toast system â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ToastContainer({ toasts }) {
  return (
    <div className="toast-container">
      {toasts.map(t => (
        <div key={t.id} className={`toast ${t.type}`}>{t.type === "success" ? "âœ“" : t.type === "error" ? "âœ—" : "â„¹"} {t.message}</div>
      ))}
    </div>
  );
}

// â”€â”€â”€ Add Player Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function AddPlayerModal({ onClose, onAdd }) {
  const [futbinId, setFutbinId] = useState("");
  const [name, setName] = useState("");
  const [rating, setRating] = useState("");
  const [position, setPosition] = useState("");
  const [platform, setPlatform] = useState("ps");
  const [loading, setLoading] = useState(false);
  const [autoFetched, setAutoFetched] = useState(false);

  const handleFutbinLookup = async () => {
    if (!futbinId.trim()) return;
    setLoading(true);
    try {
      const res = await fetch(`/.netlify/functions/fetch-price?futbin_id=${futbinId.trim()}&platform=${platform}`);
      const data = await res.json();
      if (data.name && data.name !== "Unknown") {
        setName(data.name);
        if (data.rating) setRating(String(data.rating));
        if (data.position) setPosition(data.position);
        setAutoFetched(true);
      }
    } catch (e) { /* silent - user can fill manually */ }
    setLoading(false);
  };

  const handleSubmit = () => {
    if (!futbinId.trim() || !name.trim()) return;
    onAdd({
      id: "p_" + Date.now(),
      futbin_id: futbinId.trim(),
      name: name.trim(),
      rating: parseInt(rating) || 0,
      position: position.trim().toUpperCase(),
      platform,
      created_at: new Date().toISOString(),
      active: true,
    });
  };

  return (
    <div className="modal-overlay" onClick={e => e.target === e.currentTarget && onClose()}>
      <div className="modal">
        <h2>Add Player</h2>
        <div className="form-group">
          <label className="form-label">FUTBIN ID</label>
          <div style={{ display: "flex", gap: 8 }}>
            <input className="form-input mono" placeholder="e.g. 50" value={futbinId}
              onChange={e => { setFutbinId(e.target.value); setAutoFetched(false); }}
              onKeyDown={e => e.key === "Enter" && handleFutbinLookup()}
            />
            <button className="btn" onClick={handleFutbinLookup} disabled={loading} style={{ whiteSpace: "nowrap" }}>
              {loading ? <span className="spinner" /> : "Lookup"}
            </button>
          </div>
          <div className="form-hint">Find the ID in the FUTBIN URL: /26/player/<strong>[ID]</strong>/name</div>
        </div>

        <div className="form-group">
          <label className="form-label">Player Name</label>
          <input className="form-input" placeholder="e.g. MbappÃ©" value={name} onChange={e => setName(e.target.value)} />
        </div>

        <div className="form-row">
          <div className="form-group">
            <label className="form-label">Rating</label>
            <input className="form-input mono" type="number" placeholder="91" value={rating} onChange={e => setRating(e.target.value)} />
          </div>
          <div className="form-group">
            <label className="form-label">Position</label>
            <input className="form-input" placeholder="ST" value={position} onChange={e => setPosition(e.target.value)} />
          </div>
        </div>

        <div className="form-group">
          <label className="form-label">Platform</label>
          <select className="form-select" value={platform} onChange={e => setPlatform(e.target.value)}>
            <option value="ps">PlayStation</option>
            <option value="xbox">Xbox</option>
            <option value="pc">PC</option>
          </select>
        </div>

        {autoFetched && <div style={{ fontSize: 12, color: "var(--accent-green)", marginBottom: 8 }}>âœ“ Auto-filled from FUTBIN</div>}

        <div className="modal-actions">
          <button className="btn" onClick={onClose}>Cancel</button>
          <button className="btn btn-primary" onClick={handleSubmit} disabled={!futbinId.trim() || !name.trim()}>Add Player</button>
        </div>
      </div>
    </div>
  );
}

// â”€â”€â”€ Price Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PriceChart({ playerId, prices, hours = 24 }) {
  const canvasRef = useRef(null);
  const chartRef = useRef(null);

  useEffect(() => {
    if (!canvasRef.current) return;
    const history = (prices[playerId] || []).slice(-(hours * 12));
    if (history.length < 2) return;

    if (chartRef.current) chartRef.current.destroy();

    const ctx = canvasRef.current.getContext("2d");
    const gradient = ctx.createLinearGradient(0, 0, 0, 280);
    gradient.addColorStop(0, "rgba(59, 130, 246, 0.15)");
    gradient.addColorStop(1, "rgba(59, 130, 246, 0)");

    chartRef.current = new Chart(ctx, {
      type: "line",
      data: {
        labels: history.map(p => {
          const d = new Date(p.timestamp);
          return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
        }),
        datasets: [{
          label: "Price",
          data: history.map(p => p.price),
          borderColor: "#3b82f6",
          backgroundColor: gradient,
          borderWidth: 2,
          fill: true,
          tension: 0.3,
          pointRadius: 0,
          pointHoverRadius: 5,
          pointHoverBackgroundColor: "#3b82f6",
        }],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: "#161f33",
            borderColor: "#1e2d4a",
            borderWidth: 1,
            titleFont: { family: "Outfit" },
            bodyFont: { family: "JetBrains Mono", size: 13 },
            callbacks: { label: (ctx) => ctx.parsed.y.toLocaleString() + " coins" },
          },
        },
        scales: {
          x: {
            grid: { color: "rgba(30, 45, 74, 0.4)" },
            ticks: { color: "#4f6085", font: { size: 10 }, maxTicksLimit: 8 },
          },
          y: {
            grid: { color: "rgba(30, 45, 74, 0.4)" },
            ticks: {
              color: "#4f6085",
              font: { family: "JetBrains Mono", size: 11 },
              callback: v => formatCoins(v),
            },
          },
        },
      },
    });

    return () => { if (chartRef.current) chartRef.current.destroy(); };
  }, [playerId, prices, hours]);

  const history = prices[playerId] || [];
  if (history.length < 2) {
    return <div className="empty-state" style={{ padding: 40 }}><div className="empty-state-text">Waiting for price data... Check prices to start tracking.</div></div>;
  }
  return <div className="chart-container"><canvas ref={canvasRef} /></div>;
}

// â”€â”€â”€ Player Detail View â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PlayerDetail({ player, prices, onBack }) {
  const [chartHours, setChartHours] = useState(24);
  const stats = analyzePlayer(player.id, prices);

  return (
    <div>
      <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 20 }}>
        <button className="btn btn-sm" onClick={onBack}>â† Back</button>
        <div>
          <div style={{ fontSize: 20, fontWeight: 700 }}>{player.name}</div>
          <div style={{ fontSize: 12, color: "var(--text-muted)" }}>{player.rating} OVR Â· {player.position} Â· {player.platform.toUpperCase()}</div>
        </div>
      </div>

      {stats && (
        <div className="stats-row">
          <div className="stat-card">
            <div className="stat-label">Current Price</div>
            <div className="stat-value">{formatCoins(stats.current)}</div>
          </div>
          <div className="stat-card">
            <div className="stat-label">Average</div>
            <div className="stat-value price-neutral">{formatCoins(stats.avg)}</div>
          </div>
          <div className="stat-card">
            <div className="stat-label">Range</div>
            <div className="stat-value" style={{ fontSize: 16 }}>
              <span className="price-down">{formatCoins(stats.min)}</span>
              <span style={{ color: "var(--text-muted)", margin: "0 6px" }}>â€”</span>
              <span className="price-up">{formatCoins(stats.max)}</span>
            </div>
          </div>
          <div className="stat-card">
            <div className="stat-label">Volatility</div>
            <div className={`stat-value ${parseFloat(stats.volatility) < 5 ? "price-up" : parseFloat(stats.volatility) < 15 ? "" : "price-down"}`}>{stats.volatility}%</div>
          </div>
          <div className="stat-card">
            <div className="stat-label">vs Average</div>
            <div className={`stat-value ${parseFloat(stats.percentChange) >= 0 ? "price-up" : "price-down"}`}>
              {parseFloat(stats.percentChange) >= 0 ? "+" : ""}{stats.percentChange}%
            </div>
          </div>
          <div className="stat-card">
            <div className="stat-label">Trend</div>
            <div className="stat-value">
              <span className={`trend trend-${stats.trend === "up" ? "up" : stats.trend === "down" ? "down" : ""}`}>
                {stats.trend === "up" ? "â–² Rising" : stats.trend === "down" ? "â–¼ Falling" : "â†’ Flat"}
              </span>
            </div>
          </div>
        </div>
      )}

      <div className="card">
        <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 8 }}>
          <span style={{ fontWeight: 600 }}>Price History</span>
          <div className="tabs" style={{ marginBottom: 0 }}>
            {[6, 12, 24, 48].map(h => (
              <button key={h} className={`tab ${chartHours === h ? "active" : ""}`} onClick={() => setChartHours(h)}>{h}h</button>
            ))}
          </div>
        </div>
        <PriceChart playerId={player.id} prices={prices} hours={chartHours} />
      </div>
    </div>
  );
}

// â”€â”€â”€ Main App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
  const [players, setPlayers] = useState(() => loadJSON(STORAGE_KEYS.PLAYERS, []));
  const [prices, setPrices] = useState(() => loadJSON(STORAGE_KEYS.PRICES, {}));
  const [settings, setSettings] = useState(() => loadJSON(STORAGE_KEYS.SETTINGS, {
    checkInterval: 5, threshold: 0.08, autoCheck: true,
  }));

  const [activeTab, setActiveTab] = useState("players");
  const [showAddModal, setShowAddModal] = useState(false);
  const [selectedPlayer, setSelectedPlayer] = useState(null);
  const [checking, setChecking] = useState(false);
  const [lastCheck, setLastCheck] = useState(null);
  const [toasts, setToasts] = useState([]);

  const timerRef = useRef(null);

  // Persist state
  useEffect(() => { saveJSON(STORAGE_KEYS.PLAYERS, players); }, [players]);
  useEffect(() => { saveJSON(STORAGE_KEYS.PRICES, prices); }, [prices]);
  useEffect(() => { saveJSON(STORAGE_KEYS.SETTINGS, settings); }, [settings]);

  const toast = useCallback((message, type = "info") => {
    const id = Date.now();
    setToasts(prev => [...prev, { id, message, type }]);
    setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 3500);
  }, []);

  // Add player
  const addPlayer = useCallback((player) => {
    setPlayers(prev => [...prev, player]);
    setShowAddModal(false);
    toast(`Added ${player.name}`, "success");
  }, [toast]);

  // Remove player
  const removePlayer = useCallback((id) => {
    setPlayers(prev => prev.filter(p => p.id !== id));
    setPrices(prev => { const next = { ...prev }; delete next[id]; return next; });
    if (selectedPlayer?.id === id) setSelectedPlayer(null);
    toast("Player removed", "info");
  }, [selectedPlayer, toast]);

  // Check prices
  const checkPrices = useCallback(async () => {
    if (players.length === 0) { toast("Add some players first", "info"); return; }
    setChecking(true);

    let updated = 0;
    const newPrices = { ...prices };

    for (const player of players) {
      try {
        const res = await fetch(`/.netlify/functions/fetch-price?futbin_id=${player.futbin_id}&platform=${player.platform}`);
        const data = await res.json();

        if (data.current_price && data.current_price > 0) {
          if (!newPrices[player.id]) newPrices[player.id] = [];
          newPrices[player.id].push({
            price: data.current_price,
            timestamp: new Date().toISOString(),
          });
          // Keep max 2000 entries per player
          if (newPrices[player.id].length > 2000) {
            newPrices[player.id] = newPrices[player.id].slice(-2000);
          }
          updated++;
        }
      } catch (e) {
        console.error(`Failed to fetch ${player.name}:`, e);
      }
      // Small delay between requests to be polite
      await new Promise(r => setTimeout(r, 800));
    }

    setPrices(newPrices);
    setLastCheck(new Date().toISOString());
    setChecking(false);

    if (updated > 0) toast(`Updated ${updated} player${updated > 1 ? "s" : ""}`, "success");
    else toast("No prices found â€” check FUTBIN IDs", "error");
  }, [players, prices, toast]);

  // Auto-check interval
  useEffect(() => {
    if (settings.autoCheck && players.length > 0) {
      timerRef.current = setInterval(checkPrices, settings.checkInterval * 60 * 1000);
      return () => clearInterval(timerRef.current);
    }
    return () => { if (timerRef.current) clearInterval(timerRef.current); };
  }, [settings.autoCheck, settings.checkInterval, players.length, checkPrices]);

  // Computed
  const opportunities = useMemo(() => detectOpportunities(players, prices, settings.threshold), [players, prices, settings.threshold]);

  const totalTracked = players.length;
  const totalDataPoints = Object.values(prices).reduce((sum, arr) => sum + arr.length, 0);
  const buyOpps = opportunities.filter(o => o.type === "BUY").length;
  const sellOpps = opportunities.filter(o => o.type === "SELL").length;

  // Export CSV
  const exportCSV = useCallback(() => {
    const rows = [["Player", "Rating", "Position", "Platform", "Price", "Timestamp"]];
    for (const player of players) {
      for (const entry of (prices[player.id] || [])) {
        rows.push([player.name, player.rating, player.position, player.platform, entry.price, entry.timestamp]);
      }
    }
    const csv = rows.map(r => r.join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `fc26_prices_${new Date().toISOString().slice(0, 10)}.csv`;
    a.click(); URL.revokeObjectURL(url);
    toast("CSV exported", "success");
  }, [players, prices, toast]);

  // â”€â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (selectedPlayer) {
    return (
      <div className="app-shell">
        <Topbar checking={checking} lastCheck={lastCheck} onCheck={checkPrices} />
        <div className="main-content">
          <PlayerDetail player={selectedPlayer} prices={prices} onBack={() => setSelectedPlayer(null)} />
        </div>
        <ToastContainer toasts={toasts} />
      </div>
    );
  }

  return (
    <div className="app-shell">
      <Topbar checking={checking} lastCheck={lastCheck} onCheck={checkPrices} />

      <div className="main-content">
        <div className="stats-row">
          <div className="stat-card">
            <div className="stat-label">Players Tracked</div>
            <div className="stat-value">{totalTracked}</div>
          </div>
          <div className="stat-card">
            <div className="stat-label">Data Points</div>
            <div className="stat-value">{totalDataPoints.toLocaleString()}</div>
          </div>
          <div className="stat-card">
            <div className="stat-label">Buy Signals</div>
            <div className="stat-value price-up">{buyOpps}</div>
          </div>
          <div className="stat-card">
            <div className="stat-label">Sell Signals</div>
            <div className="stat-value price-down">{sellOpps}</div>
          </div>
        </div>

        <div className="tabs">
          {[["players", "Players"], ["opportunities", "Opportunities"], ["settings", "Settings"]].map(([key, label]) => (
            <button key={key} className={`tab ${activeTab === key ? "active" : ""}`} onClick={() => setActiveTab(key)}>{label}</button>
          ))}
        </div>

        {activeTab === "players" && (
          <div>
            <div className="section-header">
              <div>
                <div className="section-title">Tracked Players</div>
                <div className="section-subtitle">{players.length} player{players.length !== 1 ? "s" : ""} Â· Last check: {lastCheck ? timeAgo(lastCheck) : "never"}</div>
              </div>
              <div style={{ display: "flex", gap: 8 }}>
                {players.length > 0 && <button className="btn btn-sm" onClick={exportCSV}>â†“ Export CSV</button>}
                <button className="btn btn-primary btn-sm" onClick={() => setShowAddModal(true)}>+ Add Player</button>
              </div>
            </div>

            {players.length === 0 ? (
              <div className="card">
                <div className="empty-state">
                  <div className="empty-state-icon">âš½</div>
                  <div className="empty-state-title">No players yet</div>
                  <div className="empty-state-text">Add your first player to start tracking FC26 prices. You'll need their FUTBIN ID from futbin.com.</div>
                  <button className="btn btn-primary" style={{ marginTop: 16 }} onClick={() => setShowAddModal(true)}>+ Add Your First Player</button>
                </div>
              </div>
            ) : (
              <div className="card" style={{ padding: 0, overflow: "hidden" }}>
                <div className="table-wrap">
                  <table>
                    <thead>
                      <tr>
                        <th>Player</th>
                        <th>Price</th>
                        <th>vs Avg</th>
                        <th>Trend</th>
                        <th>Volatility</th>
                        <th>Data Pts</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      {players.map(player => {
                        const stats = analyzePlayer(player.id, prices);
                        const dataCount = (prices[player.id] || []).length;
                        return (
                          <tr key={player.id} style={{ cursor: "pointer" }} onClick={() => setSelectedPlayer(player)}>
                            <td>
                              <div className="player-row-name">
                                <div className="player-avatar">{player.rating || "?"}</div>
                                <div>
                                  <div className="player-name-text">{player.name}</div>
                                  <div className="player-meta">{player.position} Â· {player.platform.toUpperCase()}</div>
                                </div>
                              </div>
                            </td>
                            <td><span className="price mono">{stats ? formatCoins(stats.current) : "â€”"}</span></td>
                            <td>
                              {stats ? (
                                <span className={`mono ${parseFloat(stats.percentChange) >= 0 ? "price-up" : "price-down"}`}>
                                  {parseFloat(stats.percentChange) >= 0 ? "+" : ""}{stats.percentChange}%
                                </span>
                              ) : "â€”"}
                            </td>
                            <td>
                              {stats ? (
                                <span className={`trend trend-${stats.trend === "up" ? "up" : stats.trend === "down" ? "down" : ""}`}>
                                  {stats.trend === "up" ? "â–²" : stats.trend === "down" ? "â–¼" : "â†’"}
                                </span>
                              ) : "â€”"}
                            </td>
                            <td>{stats ? <span className="mono">{stats.volatility}%</span> : "â€”"}</td>
                            <td><span className="mono" style={{ color: "var(--text-muted)" }}>{dataCount}</span></td>
                            <td onClick={e => e.stopPropagation()}>
                              <button className="btn btn-sm btn-danger btn-icon" onClick={() => removePlayer(player.id)} title="Remove">âœ•</button>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
          </div>
        )}

        {activeTab === "opportunities" && (
          <div>
            <div className="section-header">
              <div>
                <div className="section-title">Trading Opportunities</div>
                <div className="section-subtitle">Threshold: {(settings.threshold * 100).toFixed(0)}% Â· {opportunities.length} active signal{opportunities.length !== 1 ? "s" : ""}</div>
              </div>
            </div>

            {opportunities.length === 0 ? (
              <div className="card">
                <div className="empty-state">
                  <div className="empty-state-icon">ğŸ“Š</div>
                  <div className="empty-state-title">No opportunities right now</div>
                  <div className="empty-state-text">Keep tracking â€” opportunities appear when prices deviate {(settings.threshold * 100).toFixed(0)}%+ from the average. Let the app collect data for 24+ hours for best accuracy.</div>
                </div>
              </div>
            ) : (
              opportunities.map((opp, i) => (
                <div key={i} className={`opp-card ${opp.type.toLowerCase()}`}>
                  <div className="opp-header">
                    <div>
                      <span className="opp-player">{opp.player.name}</span>
                      <span style={{ marginLeft: 8 }} className="player-meta">{opp.player.rating} Â· {opp.player.position}</span>
                    </div>
                    <div style={{ display: "flex", gap: 6 }}>
                      <span className={`badge badge-${opp.type.toLowerCase()}`}>{opp.type}</span>
                      <span className={`badge badge-${opp.confidence.toLowerCase()}`}>{opp.confidence}</span>
                    </div>
                  </div>
                  <div className="opp-details">
                    <div>
                      <div className="opp-detail-label">Current Price</div>
                      <div className="opp-detail-value">{formatCoins(opp.stats.current)}</div>
                    </div>
                    <div>
                      <div className="opp-detail-label">Avg Price</div>
                      <div className="opp-detail-value">{formatCoins(opp.stats.avg)}</div>
                    </div>
                    <div>
                      <div className="opp-detail-label">{opp.type === "BUY" ? "Discount" : "Premium"}</div>
                      <div className={`opp-detail-value ${opp.type === "BUY" ? "price-up" : "price-down"}`}>{opp.discount || opp.premium}%</div>
                    </div>
                    {opp.type === "BUY" && (
                      <>
                        <div>
                          <div className="opp-detail-label">Sell Target</div>
                          <div className="opp-detail-value">{formatCoins(opp.sellPrice)}</div>
                        </div>
                        <div>
                          <div className="opp-detail-label">Profit (after tax)</div>
                          <div className="opp-detail-value price-up">{formatCoins(opp.profit)}</div>
                        </div>
                        <div>
                          <div className="opp-detail-label">ROI</div>
                          <div className="opp-detail-value price-up">{opp.roi}%</div>
                        </div>
                      </>
                    )}
                  </div>
                </div>
              ))
            )}
          </div>
        )}

        {activeTab === "settings" && (
          <div>
            <div className="section-header">
              <div className="section-title">Settings</div>
            </div>
            <div className="card">
              <div className="settings-grid">
                <div className="form-group">
                  <label className="form-label">Check Interval (minutes)</label>
                  <input className="form-input mono" type="number" min="1" max="60" value={settings.checkInterval}
                    onChange={e => setSettings(s => ({ ...s, checkInterval: parseInt(e.target.value) || 5 }))} />
                </div>
                <div className="form-group">
                  <label className="form-label">Opportunity Threshold</label>
                  <select className="form-select" value={settings.threshold} onChange={e => setSettings(s => ({ ...s, threshold: parseFloat(e.target.value) }))}>
                    <option value="0.05">5% (Sensitive)</option>
                    <option value="0.08">8% (Default)</option>
                    <option value="0.10">10% (Conservative)</option>
                    <option value="0.15">15% (Very Conservative)</option>
                  </select>
                </div>
                <div className="form-group">
                  <label className="form-label">Auto-check Prices</label>
                  <div className="toggle-wrap" style={{ marginTop: 6 }}>
                    <div className={`toggle ${settings.autoCheck ? "on" : ""}`} onClick={() => setSettings(s => ({ ...s, autoCheck: !s.autoCheck }))}>
                      <div className="toggle-knob" />
                    </div>
                    <span style={{ fontSize: 13, color: "var(--text-secondary)" }}>{settings.autoCheck ? "Enabled" : "Disabled"}</span>
                  </div>
                </div>
              </div>

              <div style={{ marginTop: 28, paddingTop: 20, borderTop: "1px solid var(--border)" }}>
                <div className="form-label" style={{ marginBottom: 12 }}>Data Management</div>
                <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
                  <button className="btn btn-sm" onClick={exportCSV}>â†“ Export All Data (CSV)</button>
                  <button className="btn btn-sm btn-danger" onClick={() => {
                    if (confirm("Clear all price history? Players will be kept.")) {
                      setPrices({});
                      toast("Price history cleared", "info");
                    }
                  }}>Clear Price History</button>
                  <button className="btn btn-sm btn-danger" onClick={() => {
                    if (confirm("Remove ALL data including players? This cannot be undone.")) {
                      setPlayers([]); setPrices({});
                      toast("All data cleared", "info");
                    }
                  }}>Reset Everything</button>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>

      {showAddModal && <AddPlayerModal onClose={() => setShowAddModal(false)} onAdd={addPlayer} />}
      <ToastContainer toasts={toasts} />
    </div>
  );
}

// â”€â”€â”€ Topbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Topbar({ checking, lastCheck, onCheck }) {
  return (
    <div className="topbar">
      <div className="topbar-logo">
        <div className="icon">F</div>
        <span>FC26</span>
        <span style={{ fontWeight: 400, color: "var(--text-muted)" }}>Price Tracker</span>
      </div>
      <div className="topbar-actions">
        {lastCheck && (
          <span style={{ fontSize: 12, color: "var(--text-muted)", display: "flex", alignItems: "center", gap: 6 }}>
            <span className="live-dot" />
            {timeAgo(lastCheck)}
          </span>
        )}
        <button className="btn btn-sm btn-primary" onClick={onCheck} disabled={checking}>
          {checking ? <><span className="spinner" /> Checking...</> : "âŸ³ Check Prices"}
        </button>
      </div>
    </div>
  );
}

// â”€â”€â”€ Mount â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ReactDOM.render(<App />, document.getElementById("root"));
</script>
</body>
</html>
